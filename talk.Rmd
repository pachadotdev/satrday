---
title: "Econometrics in R: Estimation of Gravity Models"
author: "Pach\u00e1"
institute: "satRday Santiago"
date: "Dec 15, 2018"
bibliography: references.bib
csl: ieee.csl
output:
  beamer_presentation:
    keep_tex: yes
    citation_package: natbib
    theme: metropolis
    slide_level: 2
    incremental: no
    includes:
      in_header: preamble.tex
classoption: 
  - compress
  - "aspectratio=169"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Before we begin

## This is about a new R package

![Hex sticker](hexicon.PNG)

## Where to reach me

\faTwitter or \faGithub: pachamaltese

\faEnvelopeO: `m vargas at dcc dot uchile dot cl`

\faPhone: +1 XXX XXX XX XX or +56 X X XXX XX XX

## Question to the audience

\LARGE{Do you understand (a bit) linear algebra?}
\LARGE{Have you ever fitted a regression (in R) before today?}

## Linear regression

Let $\vec{y} \in \R^n$ be the outcome and $X \in \R^{n\times p}$ be the design matrix in the context of a general model with intercept:
$$\vec{y} = X\vec{\beta} + \vec{e}$$

Being: 
$$
\underset{n\times 1}{\vec{y}} = \begin{pmatrix}y_0 \cr y_1 \cr \vdots \cr y_n\end{pmatrix}
\text{ and }
\underset{n\times p}{X} = \begin{pmatrix}1 & x_{11} & & x_{1p} \cr 1 & x_{21} & & x_{2p} \cr & \ddots & \cr 1 & x_{n1} & & x_{np}\end{pmatrix} = (\vec{1} \: \vec{x}_1 \: \ldots \: \vec{x}_p)
$$

## Linear regression

In linear models the aim is to minimize the error term by chosing $\hat{\vec{\beta}}$. One possibility is to minimize the squared error by solving this optimization problem:

\begin{equation}
\label{min}
\displaystyle \min_{\vec{\beta}} S = \|\vec{y} - X\vec{\beta}\|^2
\end{equation}

## Linear regression

Books such as @Baltagi2011 discuss how to solve \eqref{min} and other equivalent approaches that result in this optimal estimator:

\begin{equation}
\label{beta}
\hat{\vec{\beta}} = (X^tX)^{-1} X^t\vec{y}
\end{equation}

## Linear regression

With one independent variable and intercept, this is $y_i = \beta_0 + \beta_1 x_{i1} + e_i$, equation $\eqref{beta}$ means:
\begin
{equation}
\label{beta2}
\hat{\beta}_1 = cor(\vec{y},\vec{x}) \cdot \frac{sd(\vec{y})}{sd(\vec{x})} \text{ and } \hat{\beta}_0 = \bar{y} - \hat{\beta}_1 \bar{\vec{x}}
\end{equation}

## Coding example with mtcars dataset

Consider the model:
$$mpg_i = \beta_1 wt_i + \beta_2 cyl_i + e_i$$

This is how to write that model in R notation:
```{r anova_mtcars_example1, eval=FALSE, echo=TRUE}
lm(mpg ~ wt + cyl, data = mtcars)
```

## Coding example with mtcars dataset

Or written in matrix form:
```{r anova_mtcars_example2, eval=TRUE, echo=TRUE}
y <- mtcars$mpg
x0 <- rep(1, length(y))
x1 <- mtcars$wt
x2 <- mtcars$cyl
X <- cbind(x0,x1,x2)
```

## Coding example with mtcars dataset

It's the same to use `lm` or to perform a matrix multiplication because of equation $\eqref{beta}$:
```{r anova_mtcars_example3, eval=TRUE, echo=TRUE}
fit <- lm(y ~ x1 + x2)
beta <- solve(t(X)%*%X) %*% (t(X)%*%y)
```

## Coding example with mtcars dataset

It's the same to use `lm` or to perform a matrix multiplication because of equation $\eqref{beta}$:
```{r anova_mtcars_example4, eval=TRUE, echo=TRUE}
coefficients(fit)
beta
```

## Coding example with Galton dataset

Equation $\eqref{beta2}$ can be verified with R commands:
```{r anova_galton_example1, warning=FALSE, message=FALSE, echo=TRUE}
if (!require(pacman)) install.packages("pacman")
p_load(HistData)

y <- Galton$child
x <- Galton$parent
beta1 <- cor(y, x) *  sd(y) / sd(x)
beta0 <- mean(y) - beta1 * mean(x)
c(beta0, beta1)
```

## Coding example with Galton dataset

```{r anova_galton_example2}
# comparing with lm results
lm(y ~ x)
```

# Simple gravity model

## Simple gravity model

The main reference for this section is @Woelver2018 and the references therein.

Gravity models in their traditional form are inspired by Newton law of gravitation:
$$
F_{ij}=G\frac{M_{i}M_{j}}{D^{2}_{ij}}.
$$

The force $F$ between two bodies $i$ and $j$ with $i \neq j$ is proportional to the masses $M$ of these bodies and inversely proportional to the square of their geographical distance $D$. $G$ is a constant and as such of no major concern.

## Simple gravity model

The underlying idea of a traditional gravity model, shown for international trade, is equally simple:

$$
X_{ij}=G\frac{Y_{i}^{\beta_{1}}Y_{j}^{\beta_{2}}}{D_{ij}^{\beta_{3}}}.
$$

The trade flow $X$ is explained by $Y_{i}$ and $Y_{j}$ that are the masses of the exporting and importing country (e.g. the GDP) and $D_{ij}$ that is the distance between the countries.

## Simple gravity model

\LARGE{This is also used to study urban policies and migration flows!}

## Simple gravity model

Dummy variables such as common borders $contig$ or regional trade agreements $rta$ can be added to the model. Let $t_{ij}$ be the transaction cost defined as:

$$
t_{ij}= D_{ij} \exp(contig_{ij} + rta_{ij})
$$

## Simple gravity model

So that the model with friction becomes:

$$
X_{ij}=G\frac{Y_{i}^{\beta_{1}}Y_{j}^{\beta_{2}}}{t_{ij}^{\beta_{3}}}.
$$

## Simple gravity model

A logarithmic operator can be applied to form a log-linear model and use a standard estimation methods such as OLS:

$$
\log X_{ij}=\beta_{0}\log G +\beta_{1}\log Y_{i}+\beta_{2}\log Y_{j}+\beta_{3}\log D_{ij}+\beta_{4}contig_{ij}+\beta_{5}rta_{ij}
$$

# Trade barriers model

## Trade barriers model

Provided trade barriers exists, the econometric literature proposes the Multilateral Resistance model defined by the equations:

$$
X_{ij}=\frac{Y_{i}Y_{j}}{Y}\frac{t_{ij}^{1-\sigma}}{P_{j}^{1-\sigma}\Pi_{i}^{1-\sigma}}
$$
with
$$
P_{i}^{1-\sigma}=\sum_{j}\frac{t_{ij}^{1-\sigma}}{\Pi_{j}^{1-\sigma}}\frac{Y_{j}}{Y}.
$$
and
$$
\Pi_{j}^{1-\sigma}=\sum_{i}\frac{t_{ij}^{1-\sigma}}{P_{i}^{1-\sigma}}\frac{Y_{i}}{Y}
$$

## Trade barriers model

![What?](pikachu.jpg)

## Trade barriers model

Basically the model proposes that the exports $X_{ij}$ from $i$ to $j$ are determined by the supply factors in $i$, $Y_{i}$, and the demand factors in $j$, $Y_{j}$, as well as the transaction costs $t_{ij}$.

Next to information on bilateral partners $i$ and $j$, information on the rest of the world is included in the gravity model with $Y=\sum_{i} Y_{i}= \sum_{j} Y_{j}$ that represents the worldwide sum of incomes (e.g. the world's GDP).

## Trade barriers model

In this model $\sigma$ represents the elasticity of substitution between all goods. A key assumption is to take a fixed value $\sigma > 1$ in order to account for the preference for a variation of goods (e.g. in this model goods can be replaced for other similar goods).

## Trade barriers model

The Multilateral Resistance terms are included via the terms $P$, Inward Multilateral Resistance, and $\Pi$, Outward Multilateral Resistance. The Inward Multilateral Resistance $P_i$ is a function of the transaction costs of $i$ to all trade partners $j$. The Outward Multilateral Resistance $\Pi_{j}$ is a function of the transaction costs of $j$ to all trade partners $i$ and their demand.

The Multilateral Resistance terms dependent on each other. Hence, the estimation of structural gravity models becomes complex.

## Trade barriers model

![Again, what?](raichu.jpg)

# Model estimation

## Model estimation

To estimate gravity equations you need a square dataset including bilateral flows defined by the argument dependent_variable, a distance measure defined by the argument distance that is the key regressor, and other potential influences (e.g. contiguity and common currency) given as a vector in additional_regressors are required.

Some estimation methods require ISO codes or similar of type character variables to compute particular country effects. Make sure the origin and destination codes are of type "character".

## Model estimation

The rule of thumb for regressors or independent variables consists in:

* All dummy variables should be of type numeric (0/1).
* If an independent variable is defined as a ratio, it should be logged.

The user should perform some data cleaning beforehand to remove observations that contain entries that
can distort estimates, notwithstanding the functions provided within gravity package will remove zero flows and distances.

# Examples

## Double Demeaning

Double Demeaning subtracts importer and exporter averages on the left and right hand side of the respective gravity equation, and all unilateral influences including the Multilateral Resistance terms vanish. Therefore, no unilateral variables may be added as independent variables for the estimation.

## Double Demeaning

Our ddm function first logs the dependent variable and the distance variable. Afterwards, the dependent and independent variables are transformed in the following way (exemplary shown for trade flows, $X_{ij}$):

$$
(\log X_{ij})_{\text{DDM}} = (\log X_{ij}) - (\log X_{ij})_{\text{Origin Mean}} - (\log X_{ij})_{\text{Destination Mean}} + (\log X_{ij})_{\text{Mean}}.
$$

## Double Demeaning

One subtracts the mean value for the origin country and the mean value for the destination country and adds the overall mean value to the logged trade flows. This procedure is repeated for all dependent and independent variables. The transformed variables are then used for the estimation.

<!-- DDM is easily applied, but, as shown in @Head2014, its very sensitive to missing data. -->

## Double Demeaning

An example of how to apply the function ddm to an example dataset in gravity and the resulting output is shown in the following:
```{r ddm, echo=TRUE}
p_load(gravity)

fit <- ddm(
    dependent_variable = "flow",
    distance = "distw",
    additional_regressors = c("rta", "comcur", "contig"),
    code_origin = "iso_o",
    code_destination = "iso_d",
    data = gravity_no_zeros
  )
```

<!-- ## Double Demeaning -->

<!-- ```{r ddm2} -->
<!-- summary(fit) -->
<!-- ``` -->

## Double Demeaning

The package returns lm or glm objects instead of summaries. Doing that allows to use our functions in conjunction with broom or other packages, for example:
```{r ddm3, echo=TRUE}
p_load(broom)
tidy(fit)
```

## Double Demeaning

```{r ddm4, echo=TRUE}
glance(fit)
```

## Double Demeaning

```{r ddm5, echo=TRUE}
augment(fit)
```

# Code and documentation

## Code and documentation

\LARGE{github.com/pachamaltese/gravity}

\LARGE{pacha.hk/gravity}

# Questions?

## Questions?

\LARGE{Thanks for your attention!}

# References

## References

```{r, results="asis", echo=FALSE}
# PrintBibliography(bib) 
```
